<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إدارة متجر الريان - لوحة التحكم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-green: #00ff88;
            --neon-red: #ff3131;
            --neon-purple: #9d50bb;
            --bg-dark: #08081a;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            color: #fff; margin: 0; font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        #loginOverlay {
            position: fixed; inset: 0; background: var(--bg-dark);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        .login-box {
            background: rgba(15, 15, 35, 0.95); padding: 30px; border-radius: 20px;
            border: 1px solid var(--neon-blue); text-align: center; width: 90%; max-width: 350px;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        #lockMessage { color: var(--neon-red); display: none; margin-top: 15px; font-weight: bold; border: 1px solid var(--neon-red); padding: 10px; border-radius: 10px; }

        .admin-container { padding: 15px; width: 100%; max-width: 1200px; margin: 0 auto; display: none; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .tab-btn {
            flex: 1; min-width: 110px; padding: 12px; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 12px;
            cursor: pointer; font-size: 0.85rem; transition: 0.3s; white-space: nowrap;
        }
        .tab-btn.active { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.1); color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 210, 255, 0.2); }

        .admin-card { background: rgba(15, 15, 35, 0.7); padding: 15px; border-radius: 20px; border: 1px solid var(--glass); margin-bottom: 20px; }

        .table-wrapper { width: 100%; overflow-x: auto; border-radius: 15px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th { background: rgba(255,255,255,0.05); color: var(--neon-blue); padding: 12px; font-size: 0.8rem; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: center; font-size: 0.85rem; }

        .btn-action { padding: 8px 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.7rem; display: block; width: 100%; margin: 2px 0; transition: 0.2s; }
        .btn-blue { background: var(--neon-blue); color: #000; }
        .btn-green { background: var(--neon-green); color: #000; }
        .btn-red { background: var(--neon-red); color: #fff; }
        .btn-white { background: #fff; color: #000; }
        
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; display: inline-block; }
        .section-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #aaa; margin-bottom: 4px; display: inline-block; }
        .section { display: none; }
        .section.active { display: block; }

        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; text-align: center; outline: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <i class="fas fa-user-shield" style="font-size: 2.5rem; color: var(--neon-blue); margin-bottom: 15px;"></i>
        <h3>دخول الإدارة</h3>
        <div id="loginInputs">
            <input type="text" id="adminUser" placeholder="معرف المسؤول (UID)">
            <input type="password" id="adminPass" placeholder="كلمة سر الحساب">
            <p id="attemptsInfo" style="font-size: 0.75rem; color: #888; margin-top: 10px;">المحاولات المتبقية: 5</p>
            <button onclick="checkLogin()" style="width:100%; padding:12px; margin-top:15px; background:var(--neon-blue); border:none; border-radius:10px; font-weight:bold; cursor:pointer; color:#000;">دخول آمن</button>
        </div>
        <p id="lockMessage">تم حظر الوصول بسبب محاولات خاطئة!</p>
    </div>
</div>

<div class="admin-container" id="adminMainContent">
    <div style="text-align: center; margin: 15px 0;">
        <h2 style="margin: 0; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue);">لوحة تحكم الريان</h2>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('ordersTab')"><i class="fas fa-shopping-cart"></i> الطلبات</button>
        <button class="tab-btn" onclick="showTab('productsTab')"><i class="fas fa-box"></i> المنتجات</button>
        <button class="tab-btn" onclick="showTab('financialTab')"><i class="fas fa-vault"></i> المالية</button>
    </div>

    <div id="ordersTab" class="section active admin-card">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>العميل UID</th><th>الخدمة / القسم</th><th>التفاصيل</th><th>الحالة</th><th>الإجراءات</th></tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="productsTab" class="section admin-card">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>أيقونة</th><th>الاسم</th><th>السعر ($)</th><th>الفئة</th><th>الحالة</th></tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="financialTab" class="section admin-card">
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--neon-purple);">
            <h4 style="margin-top:0; color:var(--neon-purple);">شحن رصيد يدوي مباشر</h4>
            <input type="text" id="targetId" placeholder="UID العميل">
            <input type="number" id="topupAmount" placeholder="المبلغ $">
            <button class="btn-action btn-blue" onclick="addBalance()">إرسال الرصيد فوراً</button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>المستخدم والنوع</th><th>المبلغ</th><th>التفاصيل</th><th>الإجراء / الحالة</th></tr>
                </thead>
                <tbody id="financialTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/" + "AKfycbyKIYsR611T7_VORhU2UxViapC-jqtLsbflhV6tRMDI8M2SRIHfqPoMswkwChNXiY0NEg" + "/exec"; 
    let attempts = parseInt(localStorage.getItem('loginAttempts')) || 5;

    const Toast = Swal.mixin({
        background: '#0a0a23', color: '#fff', confirmButtonColor: '#00d2ff', cancelButtonColor: '#ff3131'
    });

    window.onload = () => {
        const lockTime = localStorage.getItem('lockTime');
        if (lockTime && Date.now() < lockTime) {
            setLockedUI();
        } else if (sessionStorage.getItem('adminAuth') === 'true' && localStorage.getItem('adminToken')) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminMainContent').style.display = 'block';
            refreshData();
        }
    };

    function setLockedUI() {
        document.getElementById('loginInputs').style.display = 'none';
        document.getElementById('lockMessage').style.display = 'block';
    }

    async function checkLogin() {
        const userInput = document.getElementById('adminUser').value.trim();
        const passInput = document.getElementById('adminPass').value.trim();
        if (!userInput || !passInput) return;
        try {
            Swal.fire({ title: 'جاري التحقق...', didOpen: () => Swal.showLoading() });
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: "loginManual", identifier: userInput, password: passInput })
            });
            const data = await res.json();
            if (data.accessToken && data.role.toLowerCase() === "admin") {
                attempts = 5;
                localStorage.setItem('loginAttempts', 5);
                sessionStorage.setItem('adminAuth', 'true');
                localStorage.setItem('adminToken', data.accessToken);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminMainContent').style.display = 'block';
                Swal.close();
                refreshData();
            } else { throw new Error("Invalid"); }
        } catch (e) {
            attempts--;
            localStorage.setItem('loginAttempts', attempts);
            document.getElementById('attemptsInfo').innerText = `المحاولات المتبقية: ${attempts}`;
            if (attempts <= 0) {
                localStorage.setItem('lockTime', Date.now() + (24*60*60*1000));
                setLockedUI();
            } else { Toast.fire({ icon: 'error', title: 'بيانات الدخول غير صحيحة أو لست مسؤولاً' }); }
        }
    }

    async function adminFetch(payload) {
        const token = localStorage.getItem('adminToken');
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ ...payload, Authorization: "Bearer " + token })
        });
        if (!res.ok) throw new Error("مشكلة في الشبكة");
        const text = await res.text();
        try { return JSON.parse(text); } catch (e) { return { result: text }; }
    }

    function showTab(tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
        if(tabId === 'productsTab') fetchProducts();
    }

    async function refreshData() {
        fetchOrders();
        fetchFinancial();
    }

    async function fetchOrders() {
        try {
            const data = await adminFetch({ action: "getAllOrders" });
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = (data.result || []).reverse().map(order => `
                <tr>
                    <td><small>${order.uid}</small></td>
                    <td><span class="section-tag">${order.section}</span><br><b style="color:var(--neon-blue)">${order.product}</b></td>
                    <td>${order.phone || '---'}${order.code ? `<br><b style="color:var(--neon-purple)">المرسل: ${order.code}</b>` : ''}</td>
                    <td><span class="status-badge" style="color:${order.status === 'قيد الانتظار' ? '#ffcc00' : '#00ff88'}">${order.status}</span></td>
                    <td>
                        ${order.status === 'قيد الانتظار' ? 
                        `<button class="btn-action btn-white" onclick="completeOrderWithCode(${order.row})">إتمام + كود</button>
                         <button class="btn-action btn-red" onclick="updateStatusGeneral('Orders', ${order.row}, 'ملغي')">رفض</button>` 
                        : '---'}
                    </td>
                </tr>`).join('');
        } catch (e) { console.error(e); }
    }

    async function completeOrderWithCode(row) {
        const { value: code } = await Toast.fire({ title: 'إتمام الطلب', input: 'text', showCancelButton: true });
        if (code) {
            await adminFetch({ action: "adminAction", type: "Orders", row: row, status: "مكتمل", code: code });
            fetchOrders();
        }
    }

    async function fetchFinancial() {
        try {
            const data = await adminFetch({ action: "getAllFinancialRequests" });
            const tbody = document.getElementById('financialTableBody');
            tbody.innerHTML = (data.result || []).reverse().map(req => {
                const isDep = req.type === "Deposits";
                const statusColor = req.status === 'قيد الانتظار' ? '#ffcc00' : (req.status === 'مكتمل' ? 'var(--neon-green)' : 'var(--neon-red)');
                return `
                <tr>
                    <td>
                        <small style="color:#aaa">${req.userId}</small><br>
                        ${isDep ? '<span style="color:var(--neon-green); font-size:0.7rem;">[إيداع]</span>' : '<span style="color:var(--neon-red); font-size:0.7rem;">[سحب]</span>'}
                    </td>
                    <td style="color:${isDep ? 'var(--neon-green)' : 'var(--neon-red)'}; font-weight:bold;">${req.amount}$</td>
                    <td><div style="max-width:200px; font-size:0.75rem; color:#eee; margin:0 auto; line-height:1.4;">${req.details}</div></td>
                    <td>
                        ${req.status === 'قيد الانتظار' ? 
                        `<button class="btn-action ${isDep ? 'btn-green' : 'btn-red'}" onclick="approveFinancial('${req.type}', ${req.row}, '${req.userId}', '${req.amount}')">إتمام وقبول</button>
                         <button class="btn-action btn-white" style="background:#444; color:#fff;" onclick="updateStatusGeneral('${req.type}', ${req.row}, 'ملغي')">رفض</button>` 
                        : `<span class="status-badge" style="border:1px solid ${statusColor}; color:${statusColor}">${req.status}</span>`}
                    </td>
                </tr>`;
            }).join('');
        } catch (e) { console.error(e); }
    }

    async function approveFinancial(type, row, uid, amount) {
        Swal.fire({ title: 'جاري المعالجة...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            const data = await adminFetch({ action: "adminAction", type: type, row: row, targetUid: uid, amount: parseFloat(amount), status: "مكتمل" });
            if(data.result === "success") {
                Toast.fire({ icon: 'success', title: 'تمت الموافقة وتحديث الرصيد' });
                fetchFinancial();
            } else { throw new Error(data.result || "فشلت العملية"); }
        } catch (e) { Toast.fire({ icon: 'error', title: 'خطأ: ' + e.message }); }
    }

    async function addBalance() {
        const id = document.getElementById('targetId').value.trim();
        const amt = document.getElementById('topupAmount').value;
        if (!id || !amt) return Toast.fire({ icon: 'warning', title: 'يرجى إدخال المعرف والمبلغ' });
        
        Swal.fire({ title: 'جاري الشحن...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            const res = await adminFetch({ 
                action: "adminAction", 
                type: "Deposits", 
                targetUid: String(id), 
                amount: parseFloat(amt), 
                status: "مكتمل", 
                row: "MANUAL" 
            });
            
            if (res.result === "success") {
                Toast.fire({ icon: 'success', title: 'تم شحن الرصيد بنجاح' });
                document.getElementById('targetId').value = ""; 
                document.getElementById('topupAmount').value = "";
                fetchFinancial();
            } else {
                throw new Error(res.result === "user_not_found" ? "المستخدم غير موجود" : "فشلت العملية");
            }
        } catch (e) { Toast.fire({ icon: 'error', title: e.message }); }
    }

    async function updateStatusGeneral(sheet, row, status) {
        Swal.fire({ title: 'جاري التحديث...', didOpen: () => Swal.showLoading() });
        try {
            await adminFetch({ action: "adminAction", type: sheet, row: row, status: status });
            Toast.fire({ icon: 'success', title: 'تم التحديث بنجاح' });
            refreshData();
        } catch (e) { Toast.fire({ icon: 'error', title: 'فشل التحديث' }); }
    }

    async function fetchProducts() {
        try {
            const data = await adminFetch({ action: "getProducts" });
            document.getElementById('productsTableBody').innerHTML = (data.result || []).map(p => `
                <tr><td><img src="${p.image}" width="30"></td><td>${p.name}</td><td style="color:var(--neon-green)">${p.price}$</td><td>${p.category}</td><td>نشط</td></tr>
            `).join('');
        } catch (e) { console.error(e); }
    }

    setInterval(refreshData, 45000);
</script>
</body>
</html>
